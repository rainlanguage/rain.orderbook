import type { Vault } from '$lib/typeshare/subgraphTypes';
import { invoke } from '@tauri-apps/api';
import { DEFAULT_PAGE_SIZE } from './constants';
import { mockIPC } from '@tauri-apps/api/mocks';

export type VaultsListArgs = {
  subgraphArgs: {
    url: string;
  };
  paginationArgs: {
    page: number;
    page_size: number;
  };
};

export const vaultList = async (
  url: string | undefined,
  owners: string[] = [],
  hideZeroBalance: boolean = true,
  pageParam: number,
  pageSize: number = DEFAULT_PAGE_SIZE,
) => {
  if (!url) {
    return [];
  }
  return await invoke<Vault[]>('vaults_list', {
    subgraphArgs: { url },
    filterArgs: {
      owners,
      hideZeroBalance,
    },
    paginationArgs: { page: pageParam + 1, page_size: pageSize },
  } as VaultsListArgs);
};

if (import.meta.vitest) {
  const { it, expect } = import.meta.vitest;

  it('uses the vaults_list command correctly', async () => {
    mockIPC((cmd) => {
      if (cmd === 'vaults_list') {
        return [
          {
            id: '1',
            vault_id: '1',
            owner: '0x123',
            token: {
              id: '1',
              address: '0x456',
              name: 'USDC',
              symbol: 'USDC',
              decimals: '6',
            },
            balance: '100000000000',
            orders_as_input: [],
            orders_as_output: [],
          },
        ];
      }
    });

    // check for a result with no URL
    expect(await vaultList(undefined, [], true, 0)).toEqual([]);

    // check for a result with a URL
    expect(await vaultList('http://localhost:8000', [], true, 0)).toEqual([
      {
        id: '1',
        vault_id: '1',
        owner: '0x123',
        token: {
          id: '1',
          address: '0x456',
          name: 'USDC',
          symbol: 'USDC',
          decimals: '6',
        },
        balance: '100000000000',
        orders_as_input: [],
        orders_as_output: [],
      },
    ]);

    // check with hideZeroBalance set to false
    expect(await vaultList('http://localhost:8000', [], false, 0)).toEqual([
      {
        id: '1',
        vault_id: '1',
        owner: '0x123',
        token: {
          id: '1',
          address: '0x456',
          name: 'USDC',
          symbol: 'USDC',
          decimals: '6',
        },
        balance: '100000000000',
        orders_as_input: [],
        orders_as_output: [],
      },
    ]);
  });
}
