##
## SECURITY MODEL FOR VERCEL PREVIEW DEPLOYS (PR TARGET) â€” READ BEFORE EDITING
##
## This workflow allows preview deploys for fork PRs with strict safeguards:
##  - Uses pull_request_target so secrets are available only in the base repo context.
##  - Additionally requires a maintainer to add the 'vercel-preview' label AND approve the 'vercel-preview' environment.
##  - Never runs when files in '.github/workflows/**' change (paths-ignore).
##  - Builds PR code WITHOUT secrets using a placeholder env value.
##  - Secrets are passed only to the Vercel CLI steps (not to build/test steps).
##  - Shell runs with 'bash --noprofile --norc -euo pipefail'.
##  - The Vercel CLI is invoked via an absolute path stored in $VERCEL_BIN to avoid PATH hijacking.
##
## WARNING: Changing any of the following may break the security model:
##  - Triggers (pull_request_target), label requirement, or environment approval.
##  - The '.github/workflows/**' paths-ignore.
##  - Introducing PR-controlled inputs into steps that use secrets.
##  - Relaxing the shell/ PATH hardening, or calling 'vercel' via PATH.
##  - Moving secrets to top-level env or earlier steps.
## If you modify this file, re-validate these invariants.
##
name: GitHub Actions Vercel Preview Deployment (PR Target)
on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]
    paths-ignore:
      - ".github/workflows/**"
concurrency:
  group: ${{ format('pr-{0}-vercel-preview', github.event.pull_request.number) }}
  cancel-in-progress: true
jobs:
  Deploy-Preview-PR:
    if: contains(github.event.pull_request.labels.*.name, 'vercel-preview')
    runs-on: ubuntu-latest
    permissions:
       contents: read
    environment: vercel-preview
    env:
      COMMIT_SHA: ${{ github.sha }}
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false
      - uses: nixbuild/nix-quick-install-action@v30
        with:
          nix_conf: |
            keep-env-derivations = true
            keep-outputs = true
      - name: Restore and save Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1G

      - run: ./prep-all.sh
        env:
          PUBLIC_WALLETCONNECT_PROJECT_ID: test

      - run: nix develop .#webapp-shell -c npm run build
        working-directory: packages/webapp
        env:
          PUBLIC_WALLETCONNECT_PROJECT_ID: test

      - name: Install Vercel CLI (local, pinned)
        shell: bash --noprofile --norc -euo pipefail {0}
        run: |
          VERCEL_DIR="$(mktemp -d)"
          npm install --no-audit --no-fund --no-save --ignore-scripts --prefix "$VERCEL_DIR" vercel@33.4.1
          echo "VERCEL_BIN=$VERCEL_DIR/node_modules/.bin/vercel" >> "$GITHUB_ENV"
          test -x "$VERCEL_DIR/node_modules/.bin/vercel"
        shell: bash --noprofile --norc -euo pipefail {0}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID_PREVIEWS }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PREVIEWS }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN_PREVIEWS }}
        run: |
          "$VERCEL_BIN" pull --yes --environment=preview --token="$VERCEL_TOKEN"
      - name: Deploy Project Artifacts to Vercel
        shell: bash --noprofile --norc -euo pipefail {0}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID_PREVIEWS }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PREVIEWS }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN_PREVIEWS }}
        run: |
          "$VERCEL_BIN" deploy --prebuilt --token="$VERCEL_TOKEN" packages/webapp
