<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IOrderBookV3</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../book.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../../../src/abstract/index.html">❱ abstract</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbCommon.sol/error.MinimumOutput.html">MinimumOutput</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbCommon.sol/error.Initializing.html">Initializing</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbCommon.sol/error.NonZeroBeforeArbStack.html">NonZeroBeforeArbStack</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbCommon.sol/error.BadLender.html">BadLender</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbOrderTaker.sol/error.NonZeroBeforeArbInputs.html">NonZeroBeforeArbInputs</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbOrderTaker.sol/struct.OrderBookV3ArbOrderTakerConfigV1.html">OrderBookV3ArbOrderTakerConfigV1</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbOrderTaker.sol/abstract.OrderBookV3ArbOrderTaker.html">OrderBookV3ArbOrderTaker</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3ArbOrderTaker.sol/constants.OrderBookV3ArbOrderTaker.html">OrderBookV3ArbOrderTaker constants</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/error.BadInitiator.html">BadInitiator</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/error.FlashLoanFailed.html">FlashLoanFailed</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/error.SwapFailed.html">SwapFailed</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/error.NonZeroBeforeArbInputs.html">NonZeroBeforeArbInputs</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/struct.OrderBookV3FlashBorrowerConfigV2.html">OrderBookV3FlashBorrowerConfigV2</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/abstract.OrderBookV3FlashBorrower.html">OrderBookV3FlashBorrower</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashBorrower.sol/constants.OrderBookV3FlashBorrower.html">OrderBookV3FlashBorrower constants</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashLender.sol/error.FlashLenderCallbackFailed.html">FlashLenderCallbackFailed</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashLender.sol/abstract.OrderBookV3FlashLender.html">OrderBookV3FlashLender</a></li><li class="chapter-item "><a href="../../../../src/abstract/OrderBookV3FlashLender.sol/constants.OrderBookV3FlashLender.html">OrderBookV3FlashLender constants</a></li></ol></li><li class="chapter-item "><a href="../../../../src/concrete/index.html">❱ concrete</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/concrete/GenericPoolOrderBookV3ArbOrderTaker.sol/contract.GenericPoolOrderBookV3ArbOrderTaker.html">GenericPoolOrderBookV3ArbOrderTaker</a></li><li class="chapter-item "><a href="../../../../src/concrete/GenericPoolOrderBookV3ArbOrderTaker.sol/constants.GenericPoolOrderBookV3ArbOrderTaker.html">GenericPoolOrderBookV3ArbOrderTaker constants</a></li><li class="chapter-item "><a href="../../../../src/concrete/GenericPoolOrderBookV3FlashBorrower.sol/contract.GenericPoolOrderBookV3FlashBorrower.html">GenericPoolOrderBookV3FlashBorrower</a></li><li class="chapter-item "><a href="../../../../src/concrete/GenericPoolOrderBookV3FlashBorrower.sol/constants.GenericPoolOrderBookV3FlashBorrower.html">GenericPoolOrderBookV3FlashBorrower constants</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.ReentrancyGuardReentrantCall.html">ReentrancyGuardReentrantCall</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.NotOrderOwner.html">NotOrderOwner</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.TokenMismatch.html">TokenMismatch</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.TokenDecimalsMismatch.html">TokenDecimalsMismatch</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.MinimumInput.html">MinimumInput</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.SameOwner.html">SameOwner</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.UnsupportedCalculateInputs.html">UnsupportedCalculateInputs</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.UnsupportedCalculateOutputs.html">UnsupportedCalculateOutputs</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/error.UnsupportedHandleInputs.html">UnsupportedHandleInputs</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/struct.OrderIOCalculationV2.html">OrderIOCalculationV2</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/type.Output18Amount.html">Output18Amount</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/type.Input18Amount.html">Input18Amount</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/contract.OrderBook.html">OrderBook</a></li><li class="chapter-item "><a href="../../../../src/concrete/OrderBook.sol/constants.OrderBook.html">OrderBook constants</a></li><li class="chapter-item "><a href="../../../../src/concrete/RouteProcessorOrderBookV3ArbOrderTaker.sol/contract.RouteProcessorOrderBookV3ArbOrderTaker.html">RouteProcessorOrderBookV3ArbOrderTaker</a></li><li class="chapter-item "><a href="../../../../src/concrete/RouteProcessorOrderBookV3ArbOrderTaker.sol/constants.RouteProcessorOrderBookV3ArbOrderTaker.html">RouteProcessorOrderBookV3ArbOrderTaker constants</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../src/interface/index.html">❱ interface</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/deprecated/index.html">❱ deprecated</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.DepositConfig.html">DepositConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.WithdrawConfig.html">WithdrawConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.IO.html">IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.OrderConfig.html">OrderConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.Order.html">Order</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.TakeOrdersConfig.html">TakeOrdersConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.TakeOrderConfig.html">TakeOrderConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.ClearConfig.html">ClearConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/struct.ClearStateChange.html">ClearStateChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV1.sol/interface.IOrderBookV1.html">IOrderBookV1</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.DepositConfig.html">DepositConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.WithdrawConfig.html">WithdrawConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.IO.html">IO</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.OrderConfig.html">OrderConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.Order.html">Order</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.TakeOrdersConfig.html">TakeOrdersConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.TakeOrderConfig.html">TakeOrderConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.ClearConfig.html">ClearConfig</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/struct.ClearStateChange.html">ClearStateChange</a></li><li class="chapter-item "><a href="../../../../src/interface/deprecated/IOrderBookV2.sol/interface.IOrderBookV2.html">IOrderBookV2</a></li></ol></li><li class="chapter-item "><a href="../../../../src/interface/ierc3156/index.html">❱ ierc3156</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/ierc3156/IERC3156FlashBorrower.sol/interface.IERC3156FlashBorrower.html">IERC3156FlashBorrower</a></li><li class="chapter-item "><a href="../../../../src/interface/ierc3156/IERC3156FlashBorrower.sol/constants.IERC3156FlashBorrower.html">IERC3156FlashBorrower constants</a></li><li class="chapter-item "><a href="../../../../src/interface/ierc3156/IERC3156FlashLender.sol/interface.IERC3156FlashLender.html">IERC3156FlashLender</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../src/interface/unstable/index.html">❱ unstable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/error.NoOrders.html">NoOrders</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/error.ZeroMaximumInput.html">ZeroMaximumInput</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/struct.OrderConfigV2.html">OrderConfigV2</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/struct.TakeOrderConfigV2.html">TakeOrderConfigV2</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/struct.OrderV2.html">OrderV2</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/struct.TakeOrdersConfigV2.html">TakeOrdersConfigV2</a></li><li class="chapter-item expanded "><a href="../../../../src/interface/unstable/IOrderBookV3.sol/interface.IOrderBookV3.html" class="active">IOrderBookV3</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3ArbOrderTaker.sol/interface.IOrderBookV3ArbOrderTaker.html">IOrderBookV3ArbOrderTaker</a></li><li class="chapter-item "><a href="../../../../src/interface/unstable/IOrderBookV3OrderTaker.sol/interface.IOrderBookV3OrderTaker.html">IOrderBookV3OrderTaker</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../../src/lib/index.html">❱ lib</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../src/lib/LibOrder.sol/library.LibOrder.html">LibOrder</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainlanguage/rain.orderbook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="iorderbookv3"><a class="header" href="#iorderbookv3">IOrderBookV3</a></h1>
<p><a href="https://github.com/rainlanguage/rain.orderbook/blob/8d548536c0cc7bd1e09db511507ced90923879bc/src/interface/unstable/IOrderBookV3.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
<a href="/src/interface/ierc3156/IERC3156FlashLender.sol/interface.IERC3156FlashLender.html">IERC3156FlashLender</a>, IInterpreterCallerV2</p>
<p>An orderbook that deploys <em>strategies</em> represented as interpreter
expressions rather than individual orders. The order book contract itself
behaves similarly to an <code>ERC4626</code> vault but with much more fine grained
control over how tokens are allocated and moved internally by their owners,
and without any concept of &quot;shares&quot;. Token owners MAY deposit and withdraw
their tokens under arbitrary vault IDs on a per-token basis, then define
orders that specify how tokens move between vaults according to an expression.
The expression returns a maximum amount and a token input/output ratio from
the perpective of the order. When two expressions intersect, as in their
ratios are the inverse of each other, then tokens can move between vaults.
For example, consider order A with input TKNA and output TKNB with a constant
ratio of 100:1. This order in isolation has no ability to move tokens. If
an order B appears with input TKNB and output TKNA and a ratio of 1:100 then
this is a perfect match with order A. In this case 100 TKNA will move from
order B to order A and 1 TKNB will move from order A to order B.
IO ratios are always specified as input:output and are 18 decimal fixed point
values. The maximum amount that can be moved in the current clearance is also
set by the order expression as an 18 decimal fixed point value.
Typically orders will not clear when their match is exactly 1:1 as the
clearer needs to pay gas to process the match. Each order will get exactly
the ratio it calculates when it does clear so if there is <em>overlap</em> in the
ratios then the clearer keeps the difference. In our above example, consider
order B asking a ratio of 1:110 instead of 1:100. In this case 100 TKNA will
move from order B to order A and 10 TKNA will move to the clearer's vault and
1 TKNB will move from order A to order B. In the case of fixed prices this is
not very interesting as order B could more simply take order A directly for
cheaper rather than involving a third party. Indeed, Orderbook supports a
direct &quot;take orders&quot; method that works similar to a &quot;market buy&quot;. In the case
of dynamic expression based ratios, it allows both order A and order B to
clear non-interactively according to their strategy, trading off active
management, dealing with front-running, MEV, etc. for zero-gas and
exact-ratio clearance.
The general invariant for clearing and take orders is:</p>
<pre><code>ratioA = InputA / OutputA
ratioB = InputB / OutputB
ratioA * ratioB = ( InputA * InputB ) / ( OutputA * OutputB )
OutputA &gt;= InputB
OutputB &gt;= InputA
∴ ratioA * ratioB &lt;= 1
</code></pre>
<p>Orderbook is <code>IERC3156FlashLender</code> compliant with a 0 fee flash loan
implementation to allow external liquidity from other onchain DEXes to match
against orderbook expressions. All deposited tokens across all vaults are
available for flashloan, the flashloan MAY BE REPAID BY CALLING TAKE ORDER
such that Orderbook's liability to its vaults is decreased by an incoming
trade from the flashloan borrower. See <code>ZeroExOrderBookFlashBorrower</code> for
an example of how this works in practise.
Orderbook supports many to many input/output token relationship, for example
some order can specify an array of stables it would be willing to accept in
return for some ETH. This removes the need for a combinatorial explosion of
order strategies between like assets but introduces the issue of token
decimal handling. End users understand that &quot;one&quot; USDT is roughly equal to
&quot;one&quot; DAI, but onchain this is incorrect by <em>12 orders of magnitude</em>. This
is because &quot;one&quot; DAI is <code>1e18</code> tokens and &quot;one&quot; USDT is <code>1e6</code> tokens. The
orderbook is allowing orders to deploy expressions that define <em>economic
equivalence</em> but this doesn't map 1:1 with numeric equivalence in a many to
many setup behind token decimal convensions. The solution is to require that
end users who place orders provide the decimals of each token they include
in their valid IO lists, and to calculate all amounts and ratios in their
expressions <em>as though they were 18 decimal fixed point values</em>. Orderbook
will then automatically rescale the expression values before applying the
final vault movements. If an order provides the &quot;wrong&quot; decimal values for
some token then it will simply calculate its own ratios and amounts
incorrectly which will either lead to no matching orders or a very bad trade
for the order owner. There is no way that misrepresenting decimals can attack
some other order by a counterparty. Orderbook DOES NOT read decimals from
tokens onchain because A. this would be gas for an external call to a cold
token contract and B. the ERC20 standard specifically states NOT to read
decimals from the interface onchain.
Token amounts and ratios returned by calculate order MUST be 18 decimal fixed
point values. Token amounts input to handle IO MUST be the exact absolute
values that move between the vaults, i.e. NOT rescaled to 18 decimals. The
author of the handle IO expression MUST use the token decimals and amounts to
rescale themselves if they want that logic, notably the expression author
will need to specify the desired rounding behaviour in the rescaling process.
When two orders clear there are NO TOKEN MOVEMENTS, only internal vault
balances are updated from the input and output vaults. Typically this results
in less gas per clear than calling external token transfers and also avoids
issues with reentrancy, allowances, external balances etc. This also means
that REBASING TOKENS AND TOKENS WITH DYNAMIC BALANCE ARE NOT SUPPORTED.
Orderbook ONLY WORKS IF TOKEN BALANCES ARE 1:1 WITH ADDITION/SUBTRACTION PER
VAULT MOVEMENT.
Dust due to rounding errors always favours the order. Output max is rounded
down and IO ratios are rounded up. Input and output amounts are always
converted to absolute values before applying to vault balances such that
orderbook always retains fully collateralised inventory of underlying token
balances to support withdrawals, with the caveat that dynamic token balanes
are not supported.
When an order clears it is NOT removed. Orders remain active until the owner
deactivates them. This is gas efficient as order owners MAY deposit more
tokens in a vault with an order against it many times and the order strategy
will continue to be clearable according to its expression. As vault IDs are
<code>uint256</code> values there are effectively infinite possible vaults for any token
so there is no limit to how many active orders any address can have at one
time. This also allows orders to be daisy chained arbitrarily where output
vaults for some order are the input vaults for some other order.
Expression storage is namespaced by order owner, so gets and sets are unique
to each onchain address. Order owners MUST TAKE CARE not to override their
storage sets globally across all their orders, which they can do most simply
by hashing the order hash into their get/set keys inside the expression. This
gives maximum flexibility for shared state across orders without allowing
order owners to attack and overwrite values stored by orders placed by their
counterparty.
Note that each order specifies its own interpreter and deployer so the
owner is responsible for not corrupting their own calculations with bad
interpreters. This also means the Orderbook MUST assume the interpreter, and
notably the interpreter's store, is malicious and guard against reentrancy
etc.
As Orderbook supports any expression that can run on any <code>IInterpreterV1</code> and
counterparties are available to the order, order strategies are free to
implement KYC/membership, tracking, distributions, stock, buybacks, etc. etc.
Main differences between <code>IOrderBookV2</code> and <code>IOderBookV3</code>:</p>
<ul>
<li>Most structs are now primitives to save gas.</li>
<li>Order hash is <code>bytes32</code>.</li>
<li><code>deposit</code> and <code>withdraw</code> MUST revert if the amount is zero.</li>
<li>adding an order MUST revert if there is no calculation entrypoint.</li>
<li>adding an order MUST revert if there is no handle IO entrypoint.</li>
<li>adding an order MUST revert if there are no inputs.</li>
<li>adding an order MUST revert if there are no outputs.</li>
<li>adding and removing orders MUST return a boolean indicating if the state
changed.</li>
<li>new <code>orderExists</code> method.</li>
</ul>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="vaultbalance"><a class="header" href="#vaultbalance">vaultBalance</a></h3>
<p>Get the current balance of a vault for a given owner, token and vault ID.</p>
<pre><code class="language-solidity">function vaultBalance(address owner, address token, uint256 id) external view returns (uint256 balance);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>owner</code></td><td><code>address</code></td><td>The owner of the vault.</td></tr>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token the vault is for.</td></tr>
<tr><td><code>id</code></td><td><code>uint256</code></td><td>The vault ID to read.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>balance</code></td><td><code>uint256</code></td><td>The current balance of the vault.</td></tr>
</tbody></table>
</div>
<h3 id="deposit"><a class="header" href="#deposit">deposit</a></h3>
<p><code>msg.sender</code> deposits tokens according to config. The config specifies
the vault to deposit tokens under. Delegated depositing is NOT supported.
Depositing DOES NOT mint shares (unlike ERC4626) so the overall vaulted
experience is much simpler as there is always a 1:1 relationship between
deposited assets and vault balances globally and individually. This
mitigates rounding/dust issues, speculative behaviour on derived assets,
possible regulatory issues re: whether a vault share is a security, code
bloat on the vault, complex mint/deposit/withdraw/redeem 4-way logic,
the need for preview functions, etc. etc.
At the same time, allowing vault IDs to be specified by the depositor
allows much more granular and direct control over token movements within
Orderbook than either ERC4626 vault shares or mere contract-level ERC20
allowances can facilitate.
Vault IDs are namespaced by the token address so there is no risk of
collision between tokens. For example, vault ID 0 for token A is
completely different to vault ID 0 for token B.
<code>0</code> amount deposits are unsupported as underlying token contracts
handle <code>0</code> value transfers differently and this would be a source of
confusion. The order book MUST revert with <code>ZeroDepositAmount</code> if the
amount is zero.</p>
<pre><code class="language-solidity">function deposit(address token, uint256 vaultId, uint256 amount) external;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token to deposit.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID to deposit under.</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The amount of tokens to deposit.</td></tr>
</tbody></table>
</div>
<h3 id="withdraw"><a class="header" href="#withdraw">withdraw</a></h3>
<p>Allows the sender to withdraw any tokens from their own vaults. If the
withrawer has an active flash loan debt denominated in the same token
being withdrawn then Orderbook will merely reduce the debt and NOT send
the amount of tokens repaid to the flashloan debt.
MUST revert if the amount <em>requested</em> to withdraw is zero. The withdrawal
MAY still not move any tokens (without revert) if the vault balance is
zero, or the withdrawal is used to repay a flash loan, or due to any
other internal accounting.</p>
<pre><code class="language-solidity">function withdraw(address token, uint256 vaultId, uint256 targetAmount) external;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token to withdraw.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID to withdraw from.</td></tr>
<tr><td><code>targetAmount</code></td><td><code>uint256</code></td><td>The amount of tokens to attempt to withdraw. MAY result in fewer tokens withdrawn if the vault balance is lower than the target amount. MAY NOT be zero, the order book MUST revert with <code>ZeroWithdrawTargetAmount</code> if the amount is zero.</td></tr>
</tbody></table>
</div>
<h3 id="addorder"><a class="header" href="#addorder">addOrder</a></h3>
<p>Given an order config, deploys the expression and builds the full <code>Order</code>
for the config, then records it as an active order. Delegated adding an
order is NOT supported. The <code>msg.sender</code> that adds an order is ALWAYS
the owner and all resulting vault movements are their own.
MUST revert with <code>OrderNoSources</code> if the order has no associated
calculation and <code>OrderNoHandleIO</code> if the order has no handle IO
entrypoint. The calculation MUST return at least two values from
evaluation, the maximum amount and the IO ratio. The handle IO entrypoint
SHOULD return zero values from evaluation. Either MAY revert during
evaluation on the interpreter, which MUST prevent the order from
clearing.
MUST revert with <code>OrderNoInputs</code> if the order has no inputs.
MUST revert with <code>OrderNoOutputs</code> if the order has no outputs.
If the order already exists, the order book MUST NOT change state, which
includes not emitting an event. Instead it MUST return false. If the
order book modifies state it MUST emit an <code>AddOrder</code> event and return
true.</p>
<pre><code class="language-solidity">function addOrder(OrderConfigV2 calldata config) external returns (bool stateChanged);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>config</code></td><td><code>OrderConfigV2</code></td><td>All config required to build an <code>Order</code>.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>stateChanged</code></td><td><code>bool</code></td><td>True if the order was added, false if it already existed.</td></tr>
</tbody></table>
</div>
<h3 id="orderexists"><a class="header" href="#orderexists">orderExists</a></h3>
<p>Returns true if the order exists, false otherwise.</p>
<pre><code class="language-solidity">function orderExists(bytes32 orderHash) external view returns (bool exists);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>orderHash</code></td><td><code>bytes32</code></td><td>The hash of the order to check.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>exists</code></td><td><code>bool</code></td><td>True if the order exists, false otherwise.</td></tr>
</tbody></table>
</div>
<h3 id="removeorder"><a class="header" href="#removeorder">removeOrder</a></h3>
<p>Order owner can remove their own orders. Delegated order removal is NOT
supported and will revert. Removing an order multiple times or removing
an order that never existed are valid, the event will be emitted and the
transaction will complete with that order hash definitely, redundantly
not live.</p>
<pre><code class="language-solidity">function removeOrder(OrderV2 calldata order) external returns (bool stateChanged);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>order</code></td><td><code>OrderV2</code></td><td>The <code>Order</code> data exactly as it was added.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>stateChanged</code></td><td><code>bool</code></td><td>True if the order was removed, false if it did not exist.</td></tr>
</tbody></table>
</div>
<h3 id="takeorders"><a class="header" href="#takeorders">takeOrders</a></h3>
<p>Allows <code>msg.sender</code> to attempt to fill a list of orders in sequence
without needing to place their own order and clear them. This works like
a market buy but against a specific set of orders. Every order will
looped over and calculated individually then filled maximally until the
request input is reached for the <code>msg.sender</code>. The <code>msg.sender</code> is
responsible for selecting the best orders at the time according to their
criteria and MAY specify a maximum IO ratio to guard against an order
spiking the ratio beyond what the <code>msg.sender</code> expected and is
comfortable with. As orders may be removed and calculate their ratios
dynamically, all issues fulfilling an order other than misconfiguration
by the <code>msg.sender</code> are no-ops and DO NOT revert the transaction. This
allows the <code>msg.sender</code> to optimistically provide a list of orders that
they aren't sure will completely fill at a good price, and fallback to
more reliable orders further down their list. Misconfiguration such as
token mismatches are errors that revert as this is known and static at
all times to the <code>msg.sender</code> so MUST be provided correctly. <code>msg.sender</code>
MAY specify a minimum input that MUST be reached across all orders in the
list, otherwise the transaction will revert, this MAY be set to zero.
Exactly like withdraw, if there is an active flash loan for <code>msg.sender</code>
they will have their outstanding loan reduced by the final input amount
preferentially before sending any tokens. Notably this allows arb bots
implemented as flash loan borrowers to connect orders against external
liquidity directly by paying back the loan with a <code>takeOrders</code> call and
outputting the result of the external trade.
Rounding errors always favour the order never the <code>msg.sender</code>.</p>
<pre><code class="language-solidity">function takeOrders(TakeOrdersConfigV2 calldata config) external returns (uint256 totalInput, uint256 totalOutput);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>config</code></td><td><code>TakeOrdersConfigV2</code></td><td>The constraints and list of orders to take, orders are processed sequentially in order as provided, there is NO ATTEMPT onchain to predict/filter/sort these orders other than evaluating them as provided. Inputs and outputs are from the perspective of <code>msg.sender</code> except for values specified by the orders themselves which are the from the perspective of that order.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>totalInput</code></td><td><code>uint256</code></td><td>Total tokens sent to <code>msg.sender</code>, taken from order vaults processed.</td></tr>
<tr><td><code>totalOutput</code></td><td><code>uint256</code></td><td>Total tokens taken from <code>msg.sender</code> and distributed between vaults.</td></tr>
</tbody></table>
</div>
<h3 id="clear"><a class="header" href="#clear">clear</a></h3>
<p>Allows <code>msg.sender</code> to match two live orders placed earlier by
non-interactive parties and claim a bounty in the process. The clearer is
free to select any two live orders on the order book for matching and as
long as they have compatible tokens, ratios and amounts, the orders will
clear. Clearing the orders DOES NOT remove them from the orderbook, they
remain live until explicitly removed by their owner. Even if the input
vault balances are completely emptied, the orders remain live until
removed. This allows order owners to deploy a strategy over a long period
of time and periodically top up the input vaults. Clearing two orders
from the same owner is disallowed.
Any mismatch in the ratios between the two orders will cause either more
inputs than there are available outputs (transaction will revert) or less
inputs than there are available outputs. In the latter case the excess
outputs are given to the <code>msg.sender</code> of clear, to the vaults they
specify in the clear config. This not only incentivises &quot;automatic&quot; clear
calls for both alice and bob, but incentivises <em>prioritising greater
ratio differences</em> with a larger bounty. The second point is important
because it implicitly prioritises orders that are further from the
current market price, thus putting constant increasing pressure on the
entire system the further it drifts from the norm, no matter how esoteric
the individual order expressions and sizings might be.
All else equal there are several factors that would impact how reliably
some order clears relative to the wider market, such as:</p>
<ul>
<li>Bounties are effectively percentages of cleared amounts so larger
orders have larger bounties and cover gas costs more easily</li>
<li>High gas on the network means that orders are harder to clear
profitably so the negative spread of the ratios will need to be larger</li>
<li>Complex and stateful expressions cost more gas to evalulate so the
negative spread will need to be larger</li>
<li>Erratic behavior of the order owner could reduce the willingness of
third parties to interact if it could result in wasted gas due to
orders suddently being removed before clearance etc.</li>
<li>Dynamic and highly volatile words used in the expression could be
ignored or low priority by clearers who want to be sure that they can
accurately predict the ratios that they include in their clearance</li>
<li>Geopolitical issues such as sanctions and regulatory restrictions could
cause issues for certain owners and clearers</li>
</ul>
<pre><code class="language-solidity">function clear(
    OrderV2 memory alice,
    OrderV2 memory bob,
    ClearConfig calldata clearConfig,
    SignedContextV1[] memory aliceSignedContext,
    SignedContextV1[] memory bobSignedContext
) external;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>alice</code></td><td><code>OrderV2</code></td><td>Some order to clear.</td></tr>
<tr><td><code>bob</code></td><td><code>OrderV2</code></td><td>Another order to clear.</td></tr>
<tr><td><code>clearConfig</code></td><td><code>ClearConfig</code></td><td>Additional configuration for the clearance such as how to handle the bounty payment for the <code>msg.sender</code>.</td></tr>
<tr><td><code>aliceSignedContext</code></td><td><code>SignedContextV1[]</code></td><td>Optional signed context that is relevant to A.</td></tr>
<tr><td><code>bobSignedContext</code></td><td><code>SignedContextV1[]</code></td><td>Optional signed context that is relevant to B.</td></tr>
</tbody></table>
</div>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="deposit-1"><a class="header" href="#deposit-1">Deposit</a></h3>
<p>Some tokens have been deposited to a vault.</p>
<pre><code class="language-solidity">event Deposit(address sender, address token, uint256 vaultId, uint256 amount);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> depositing tokens. Delegated deposits are NOT supported.</td></tr>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token being deposited.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID the tokens are being deposited under.</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The amount of tokens deposited.</td></tr>
</tbody></table>
</div>
<h3 id="withdraw-1"><a class="header" href="#withdraw-1">Withdraw</a></h3>
<p>Some tokens have been withdrawn from a vault.</p>
<pre><code class="language-solidity">event Withdraw(address sender, address token, uint256 vaultId, uint256 targetAmount, uint256 amount);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> withdrawing tokens. Delegated withdrawals are NOT supported.</td></tr>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token being withdrawn.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID the tokens are being withdrawn from.</td></tr>
<tr><td><code>targetAmount</code></td><td><code>uint256</code></td><td>The amount of tokens requested to withdraw.</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The amount of tokens withdrawn, can be less than the target amount if the vault does not have the funds available to cover the target amount. For example an active order might move tokens before the withdraw completes.</td></tr>
</tbody></table>
</div>
<h3 id="addorder-1"><a class="header" href="#addorder-1">AddOrder</a></h3>
<p>An order has been added to the orderbook. The order is permanently and
always active according to its expression until/unless it is removed.</p>
<pre><code class="language-solidity">event AddOrder(address sender, IExpressionDeployerV3 expressionDeployer, OrderV2 order, bytes32 orderHash);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> adding the order and is owner of the order.</td></tr>
<tr><td><code>expressionDeployer</code></td><td><code>IExpressionDeployerV3</code></td><td>The expression deployer that ran the integrity check for this order. This is NOT included in the <code>Order</code> itself but is important for offchain processes to ignore untrusted deployers before interacting with them.</td></tr>
<tr><td><code>order</code></td><td><code>OrderV2</code></td><td>The newly added order. MUST be handed back as-is when clearing orders and contains derived information in addition to the order config that was provided by the order owner.</td></tr>
<tr><td><code>orderHash</code></td><td><code>bytes32</code></td><td>The hash of the order as it is recorded onchain. Only the hash is stored in Orderbook storage to avoid paying gas to store the entire order.</td></tr>
</tbody></table>
</div>
<h3 id="removeorder-1"><a class="header" href="#removeorder-1">RemoveOrder</a></h3>
<p>An order has been removed from the orderbook. This effectively
deactivates it. Orders can be added again after removal.</p>
<pre><code class="language-solidity">event RemoveOrder(address sender, OrderV2 order, bytes32 orderHash);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> removing the order and is owner of the order.</td></tr>
<tr><td><code>order</code></td><td><code>OrderV2</code></td><td>The removed order.</td></tr>
<tr><td><code>orderHash</code></td><td><code>bytes32</code></td><td>The hash of the removed order.</td></tr>
</tbody></table>
</div>
<h3 id="takeorder"><a class="header" href="#takeorder">TakeOrder</a></h3>
<p>Some order has been taken by <code>msg.sender</code>. This is the same as them
placing inverse orders then immediately clearing them all, but costs less
gas and is more convenient and reliable. Analogous to a market buy
against the specified orders. Each order that is matched within a the
<code>takeOrders</code> loop emits its own individual event.</p>
<pre><code class="language-solidity">event TakeOrder(address sender, TakeOrderConfigV2 config, uint256 input, uint256 output);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> taking the orders.</td></tr>
<tr><td><code>config</code></td><td><code>TakeOrderConfigV2</code></td><td>All config defining the orders to attempt to take.</td></tr>
<tr><td><code>input</code></td><td><code>uint256</code></td><td>The input amount from the perspective of sender.</td></tr>
<tr><td><code>output</code></td><td><code>uint256</code></td><td>The output amount from the perspective of sender.</td></tr>
</tbody></table>
</div>
<h3 id="ordernotfound"><a class="header" href="#ordernotfound">OrderNotFound</a></h3>
<p>Emitted when attempting to match an order that either never existed or
was removed. An event rather than an error so that we allow attempting
many orders in a loop and NOT rollback on &quot;best effort&quot; basis to clear.</p>
<pre><code class="language-solidity">event OrderNotFound(address sender, address owner, bytes32 orderHash);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> clearing the order that wasn't found.</td></tr>
<tr><td><code>owner</code></td><td><code>address</code></td><td>Owner of the order that was not found.</td></tr>
<tr><td><code>orderHash</code></td><td><code>bytes32</code></td><td>Hash of the order that was not found.</td></tr>
</tbody></table>
</div>
<h3 id="orderzeroamount"><a class="header" href="#orderzeroamount">OrderZeroAmount</a></h3>
<p>Emitted when an order evaluates to a zero amount. An event rather than an
error so that we allow attempting many orders in a loop and NOT rollback
on a &quot;best effort&quot; basis to clear.</p>
<pre><code class="language-solidity">event OrderZeroAmount(address sender, address owner, bytes32 orderHash);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> clearing the order that had a 0 amount.</td></tr>
<tr><td><code>owner</code></td><td><code>address</code></td><td>Owner of the order that evaluated to a 0 amount.</td></tr>
<tr><td><code>orderHash</code></td><td><code>bytes32</code></td><td>Hash of the order that evaluated to a 0 amount.</td></tr>
</tbody></table>
</div>
<h3 id="orderexceedsmaxratio"><a class="header" href="#orderexceedsmaxratio">OrderExceedsMaxRatio</a></h3>
<p>Emitted when an order evaluates to a ratio exceeding the counterparty's
maximum limit. An error rather than an error so that we allow attempting
many orders in a loop and NOT rollback on a &quot;best effort&quot; basis to clear.</p>
<pre><code class="language-solidity">event OrderExceedsMaxRatio(address sender, address owner, bytes32 orderHash);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> clearing the order that had an excess ratio.</td></tr>
<tr><td><code>owner</code></td><td><code>address</code></td><td>Owner of the order that had an excess ratio.</td></tr>
<tr><td><code>orderHash</code></td><td><code>bytes32</code></td><td>Hash of the order that had an excess ratio.</td></tr>
</tbody></table>
</div>
<h3 id="clear-1"><a class="header" href="#clear-1">Clear</a></h3>
<p>Emitted before two orders clear. Covers both orders and includes all the
state before anything is calculated.</p>
<pre><code class="language-solidity">event Clear(address sender, OrderV2 alice, OrderV2 bob, ClearConfig clearConfig);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> clearing both orders.</td></tr>
<tr><td><code>alice</code></td><td><code>OrderV2</code></td><td>One of the orders.</td></tr>
<tr><td><code>bob</code></td><td><code>OrderV2</code></td><td>The other order.</td></tr>
<tr><td><code>clearConfig</code></td><td><code>ClearConfig</code></td><td>Additional config required to process the clearance.</td></tr>
</tbody></table>
</div>
<h3 id="afterclear"><a class="header" href="#afterclear">AfterClear</a></h3>
<p>Emitted after two orders clear. Includes all final state changes in the
vault balances, including the clearer's vaults.</p>
<pre><code class="language-solidity">event AfterClear(address sender, ClearStateChange clearStateChange);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> clearing the order.</td></tr>
<tr><td><code>clearStateChange</code></td><td><code>ClearStateChange</code></td><td>The final vault state changes from the clearance.</td></tr>
</tbody></table>
</div>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<h3 id="zerodepositamount"><a class="header" href="#zerodepositamount">ZeroDepositAmount</a></h3>
<p>MUST be thrown by <code>deposit</code> if the amount is zero.</p>
<pre><code class="language-solidity">error ZeroDepositAmount(address sender, address token, uint256 vaultId);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> depositing tokens.</td></tr>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token being deposited.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID the tokens are being deposited under.</td></tr>
</tbody></table>
</div>
<h3 id="zerowithdrawtargetamount"><a class="header" href="#zerowithdrawtargetamount">ZeroWithdrawTargetAmount</a></h3>
<p>MUST be thrown by <code>withdraw</code> if the amount <em>requested</em> to withdraw is
zero. The withdrawal MAY still not move any tokens if the vault balance
is zero, or the withdrawal is used to repay a flash loan.</p>
<pre><code class="language-solidity">error ZeroWithdrawTargetAmount(address sender, address token, uint256 vaultId);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sender</code></td><td><code>address</code></td><td><code>msg.sender</code> withdrawing tokens.</td></tr>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token being withdrawn.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID the tokens are being withdrawn from.</td></tr>
</tbody></table>
</div>
<h3 id="ordernosources"><a class="header" href="#ordernosources">OrderNoSources</a></h3>
<p>MUST be thrown by <code>addOrder</code> if the order has no associated calculation.</p>
<pre><code class="language-solidity">error OrderNoSources();
</code></pre>
<h3 id="ordernohandleio"><a class="header" href="#ordernohandleio">OrderNoHandleIO</a></h3>
<p>MUST be thrown by <code>addOrder</code> if the order has no associated handle IO.</p>
<pre><code class="language-solidity">error OrderNoHandleIO();
</code></pre>
<h3 id="ordernoinputs"><a class="header" href="#ordernoinputs">OrderNoInputs</a></h3>
<p>MUST be thrown by <code>addOrder</code> if the order has no inputs.</p>
<pre><code class="language-solidity">error OrderNoInputs();
</code></pre>
<h3 id="ordernooutputs"><a class="header" href="#ordernooutputs">OrderNoOutputs</a></h3>
<p>MUST be thrown by <code>addOrder</code> if the order has no outputs.</p>
<pre><code class="language-solidity">error OrderNoOutputs();
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../src/interface/unstable/IOrderBookV3.sol/struct.TakeOrdersConfigV2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../src/interface/unstable/IOrderBookV3ArbOrderTaker.sol/interface.IOrderBookV3ArbOrderTaker.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../src/interface/unstable/IOrderBookV3.sol/struct.TakeOrdersConfigV2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../src/interface/unstable/IOrderBookV3ArbOrderTaker.sol/interface.IOrderBookV3ArbOrderTaker.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../../solidity.min.js"></script>


    </div>
    </body>
</html>
